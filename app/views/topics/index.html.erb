<div id='header'>
	<h1 class='xxlarge title'>Project Clue</h1>

	<div class='datebox'>
		<h3 id='date'>
			Headline - <span><%= @day.date.to_s %></span>
		</h3>
	</div>
</div>

<div id='container'>
	<div id='topics'>
		<div class='btn btn_l'>
			<i class="fa fa-chevron-left"></i>
		</div>
		<div id='topic_list'>
			<%= render partial: 'topics/topic', local: @topics, layout: false %>
			</div>
		<div class='btn btn_r'>
			<i class="fa fa-chevron-right	fa-5"></i>
		</div>
		<hr>
	</div>
	<div id='statistics'>
		<div class='buttons'>
			<div class='btn' id='twitter_popularity'>Twitter</div>
			<div class='btn' id='facebook_popularity'>Facebook</div>
			<div class='btn' id='google_trend_index'>Google</div>
			<hr>
		</div>
		<div id='chart' class='noselect'></div>
	</div>
	<div id='articles'>
		<div class='btn btn_l'>
			<i class="fa fa-chevron-left	fa-5"></i>
		</div>
		<div id='article_list'>
			<%= render partial: 'topics/article', local: @articles, layout: false %>
		</div>
		<div class='btn btn_r'>
			<i class="fa fa-chevron-right	fa-5"></i>
		</div>
		<hr>
	</div>
	<div id='article-page'>
	<% if @articles.count == 1 %>
		Article 1 of 1
	<% else %>
		<p>Articles <span id='article-page-indicator'>1-<%= @articles.count %></span> of <%= @total_articles %> Total</p>
	<% end %>
	</div>
</div>
<div id='footer'>
	Created by: Vince Li, Alex Drennen, Shomari Ewing, Dustin Snyder
</footer>
<script type='text/javascript'>
	var topicId = <%= @topics[0].id %>;
	var dayId = <%= @day.id %>;
	var articlePage = 1;
	var articlePageTotal = <%= (@total_articles / @articles_per_page.to_f).ceil %>;
	var maxDate = '<%= @maxDay %>';
	var minDate = '<%= @minDay %>';

	var parseDate = d3.time.format("%Y-%m-%d").parse;
	var currentStatistic = 'twitter_popularity';

	function partialDataset() {
		var newSet = [];
		var newObj = {};
		for(var i=0; i < fullDataset.length; i++) {
			newObj = {};
			newObj['date'] = parseDate(fullDataset[i].date);
			newObj[currentStatistic] = fullDataset[i][currentStatistic];
			newObj['day'] = fullDataset[i].day;
			newSet.push(newObj);
		}
		return newSet;
	}

	var fullDataset=JSON.parse('<%= raw @dataset %>');
	var dataset = partialDataset();
	
	var margin = {top: 20, right: 30, bottom: 30, left: 50},
	    width = 865 - margin.left - margin.right,
	    height = 288 - margin.top - margin.bottom;

	var xScale = d3.time.scale()
		.range([0, width]);

	var yScale = d3.scale.linear()
		.range([height, 0]);

	var xAxis = d3.svg.axis()
		.scale(xScale)
		.orient('bottom');

	var yAxis = d3.svg.axis()
		.scale(yScale)
		.orient('left');

	var area = d3.svg.area()
		//.interpolate("basis")
		.interpolate("monotone")
		//.interpolate("cardinal")
		.x(function(d) { return xScale(d.date); })
		.y0(height)
		.y1(function(d) { return yScale(d[currentStatistic]); });

	var svg = d3.select("#chart").append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	populateGraph();

	function populateGraph() {
		d3.selectAll('.axis').remove();
		d3.selectAll('.area').remove();
		d3.selectAll('text').remove();
		d3.selectAll('circle').remove();

		xScale.domain(d3.extent(dataset, function(d) { return d.date; }));
		yScale.domain(d3.extent(dataset, function(d) { return d[currentStatistic]; }));

		svg.append("path")
			.datum(dataset)
			.attr("class", "area")
			.attr("d", area);


		svg.append("g")
			.attr("class", "x axis")
			.attr("transform", "translate(0," + height + ")")
			.call(xAxis);

		svg.append("g")
			.attr("class", "y axis")
			.call(yAxis)
			.append("text")
			.attr("transform", "rotate(-90)")
			.attr("y", 6)
			.attr("dy", ".71em")
			.style("text-anchor", "end")
			.text(currentStatistic.replace(/_/g, ' '));

		var circles = svg.selectAll('circle').data(dataset).enter()
			.append('circle')
			.attr('class', 'standard')
			.attr('fill','steelblue')
			.attr('stroke', 'white')
			.attr('stroke-width', '2px')
			.attr('r', '5px')
			.attr('cx', function(d) { return xScale(d.date); })
			.attr('cy', function(d) { return yScale(d[currentStatistic]); });

		var circles = svg.selectAll('circle.overlay').data(dataset).enter()
			.append('circle')
			.attr('class', 'overlay')
			.attr('fill','transparent')
			.attr('stroke-width', '1px')
			.attr('r', '20px')
			.attr('cx', function(d) { return xScale(d.date); })
			.attr('cy', function(d) { return yScale(d[currentStatistic]); });

		d3.selectAll('circle.overlay').on('mouseover',function(){
			var data = this.__data__.date;
			d3.selectAll('circle.standard').attr('fill', function(d){
				return this.__data__.date == data ? 'black' : 'steelblue';
			});
		});

		d3.selectAll('circle.overlay').on('mouseout',function(){
			var data = this.__data__.date;
			d3.selectAll('circle.standard').attr('fill', function(d){
				return 'steelblue';
			});
		});

		d3.selectAll('circle').on('click',function(){
			var date = this.__data__.date.toISOString().replace(/T.*/i,'');
			var day = this.__data__.day;
			var url = 'topics/'+topicId+'/date/'+day+'/articles/1';
			$.ajax({
				url: url,
				type: 'get',
				dataType: 'html',
				success: function(response) {
					dayId = day;
					articlePage = 1;
					$('#article_list').html(response);
					articlePageTotal = $('.article').first().data('total-articles');
				}
			});
		});

		d3.select('svg').on('mousedown', function(){
			svg.append("line")
				.attr('class','left-bracket')
				.attr('opacity',0.5)
				.attr('stroke','black')
				.attr('stroke-width','2px')
				.attr("x1", d3.mouse(this)[0]-margin.left)
				.attr("y1", 0)
				.attr("x2", d3.mouse(this)[0]-margin.left)
				.attr("y2", height);
		});

		d3.select('svg').on('mouseup', function(){
			svg.select("line.left-bracket").remove();
		});

		d3.select('svg').on('mousemove', function () {
		  x = d3.mouse(this)[0];
		  d3.selectAll('line.left-bracket')
		   	.attr('x1', (x-margin.left)+'px')
		   	.attr('x2', (x-margin.left)+'px');    
		});

		$('#chart').on('mousedown',function(e){
			$(this).addClass('active');
			$(this).css('cursor','default');
		});
		$('#chart').on('mouseup',function(e){
			$(this).removeClass('active');
			$(this).css('cursor', 'default')
		});
		$('#chart.active').on('hover',function(e){
			e.stopPropagation();
			$(this).css('cursor', 'default')
		});
	}
</script>
